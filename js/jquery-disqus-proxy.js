function tryToLoadDisqus(e){var n=!1,o=document.createElement("script"),t=window.disqusProxy.shortname;$("#disqus_thread").text("正在尝试加载 disqus ……"),o.src="https://"+t+".disqus.com/embed.js",o.async=!0,o.setAttribute("data-timestamp",String(+new Date)),o.onload=function(){n=!0},o.onerror=function(){e()},setTimeout(function(){n||e()},3e3),document.body.appendChild(o)}function loadDisqusProxy(){disqusProxyIsLoading||(disqusProxyIsLoading=!0,console.warn("disqus 加载失败，开始加载 disqus-proxy"),$("#disqus_thread").remove(),$("#disqus_proxy_thread").text("正在加载基础版 disqus ……"),loadThread(function(e){renderCommentBox(e.response[0].id),bingSubmitToCommentBox(),loadComments(function(e){renderComments(e)})}))}function loadThread(e){var n=window.disqusProxy.identifier,o="identifier="+encodeURIComponent(n),t="//"+window.disqusProxy.server+":"+window.disqusProxy.port.toString()+"/api/getThreads";$.get(t+"?"+o,e)}function renderCommentBox(e){var n='    <div class="comment-box">      <form class="comment-box-form" method="post" action="">        <div class="row author-row">          <input type="text" style="display:none" name="thread" value="{0}"/>          <input type="text" required name="author_name" placeholder="请输入昵称"/>          <input type="email" required name="author_email" placeholder="请输入邮箱（不会公开显示）"/>        </div>        <div class="row message-row">          <textarea name="message" required rows="3" placeholder="在此处输入评论内容"></textarea>        </div>        <div class="action-row">          <span class="notification"></span>          <input type="submit" id="submit" value="发表" />        </div>      </form>    </div>'.format(e);$("#disqus_proxy_thread").html(n)}function bingSubmitToCommentBox(){var e=!1;$(".comment-box-form").submit(function(n){if(n.preventDefault(),e)return!1;e=!0,$("#submit").val("提交中.."),$(".notification").text("");var o="//"+window.disqusProxy.server+":"+window.disqusProxy.port.toString()+"/api/createComment";$.post(o,$(this).serialize(),"json").success(function(n){e=!1,$("#submit").val("发表"),0===n.code?($(".notification").html('<span class="success">发表成功，请等待审核。</span>'),$('input[name="author_name"]').val(""),$('input[name="author_email"]').val(""),$('textarea[name="message"]').val("")):$(".notification").html('<span class="error">发表失败</span>')}).error(function(e,n,o){$(".notification").html('<span class="success">网络错误：'+o+"</span>")})})}function loadComments(e){var n=window.disqusProxy.identifier,o="identifier="+encodeURIComponent(n),t="//"+window.disqusProxy.server+":"+window.disqusProxy.port.toString()+"/api/getComments";$("#disqus_proxy_thread").append('<ul class="comment-list"><li>正在加载评论……</li></ul>'),$.get(t+"?"+o).success(function(n){e(n.response||[])}).error(function(e,n,o){$(".comment-list").html("<li>网络错误："+o+"</li>")})}function renderComments(e){function n(e){if(0===t.length)return null;var o=[];return t.forEach(function(t){t.parent===e&&o.unshift({comment:t,author:t.author.name,isPrimary:t.author.username===window.disqusProxy.username||-1!==t.author.name.indexOf(window.disqusProxy.username),children:n(+t.id)})}),o.length?o:null}var o=[],t=[];e.forEach(function(e){(e.parent?t:o).push(e)});var r=o.map(function(e){return{comment:e,author:e.author.name,isPrimary:e.author.username===window.disqusProxy.username||-1!==e.author.name.indexOf(window.disqusProxy.username),children:n(+e.id)}});$("#disqus_proxy_thread > .comment-list").html(r.map(function(e){return"<li>{0}</li>".format(renderComment(e))}).join("")||"<li>暂无评论，快来抢沙发！</li>")}function getAvatar(e){function n(e){for(var n=0,o=0;o<e.length;o++)n+=e.charCodeAt(o);return"rgb({0}, {1}, {2})".format(n%255,n%245,n%235)}return-1===e.avatar.cache.indexOf("noavatar")?e.avatar.cache:blockies.create({seed:e.name,color:n(e.name+"color"),bgcolor:n(e.name+"bgcolor"),spotcolor:n(e.name+"spotcolor")}).toDataURL()}function renderComment(e){var n=e.isPrimary?window.disqusProxy.adminAvatar:getAvatar(e.comment.author),o=e.comment.author.name,t=e.isPrimary?'<span class="admin">Admin</span>':"",r=e.replyTo?'<span class="replyTo">{0}</span>'.format(e.replyTo):"",a=new Date(e.comment.createdAt).toLocaleString(),i=e.comment.message,s=e.children?e.children.map(function(n){return"<li>{0}</li>".format(renderComment({comment:n.comment,author:n.author,isPrimary:n.isPrimary,replyTo:e.author,children:n.children}))}).join(""):"";return'      <div class="comment-item">        <div class="comment-avatar"><img src={0} alt="avatar" /></div>        <div class="comment-content">          <div class="comment-header">            <span class="author-name">{1}</span>{2}{3}<span class="date">{4}</span>          </div>          <div class="comment-body">{5}</div>        </div>        {6}      </div>'.format(n,o,t,r,a,i,e.children?'<ul class="post-reply">{0}<ul>'.format(s):"")}String.prototype.format=String.prototype.f=function(){for(var e=this,n=arguments.length;n--;)e=e.replace(new RegExp("\\{"+n+"\\}","gm"),arguments[n]);return e};var disqusProxyIsLoading=!1;window.disqusProxy&&tryToLoadDisqus(loadDisqusProxy);